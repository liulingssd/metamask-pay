<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>MetaMask 支付</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      text-align: center;
    }
    button {
      background: #f6851b;
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    #log { margin-top: 20px; color: #333; word-break: break-all; }
  </style>
</head>
<body>
  <h2>MetaMask 支付</h2>
  <p id="info">准备唤起 MetaMask...</p>
  <button id="payBtn" style="display:none;">发起支付</button>
  <div id="log"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search)
    const to = urlParams.get('to')
    const amount = urlParams.get('amount') || '0.001'
    const callback = urlParams.get('callback')

    const log = msg => document.getElementById('log').innerText += msg + '\n'

    async function pay() {
      try {
        if (!window.ethereum) {
          document.getElementById('info').innerText = 'MetaMask 未注入，请在 MetaMask 内打开此页面'
          return
        }
        await window.ethereum.request({ method: 'eth_requestAccounts' })
        const provider = new ethers.BrowserProvider(window.ethereum)
        const signer = await provider.getSigner()
        const tx = await signer.sendTransaction({
          to: to,
          value: ethers.parseEther(amount)
        })
        log('交易已发送，等待确认...')
        log('Tx Hash: ' + tx.hash)

        if (callback) {
          setTimeout(() => {
            window.location.href = callback + '?txHash=' + tx.hash
          }, 1500)
        }
      } catch (e) {
        log('错误: ' + e.message)
      }
    }

    // 检测是否在 MetaMask 内打开
    if (!window.ethereum && !window.location.href.startsWith('metamask://')) {
      const deeplink = `metamask://dapp/liulingssd.github.io/metamask-pay/pay.html?${urlParams.toString()}`
      document.getElementById('info').innerText = '正在跳转到 MetaMask...'
      setTimeout(() => window.location.href = deeplink, 800)
    } else {
      document.getElementById('payBtn').style.display = 'inline-block'
      document.getElementById('payBtn').addEventListener('click', pay)
      document.getElementById('info').innerText = `准备支付 ${amount} ETH 到 ${to}`
    }
  </script>
</body>
</html>












