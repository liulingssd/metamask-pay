<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Binance Wallet USDT 支付</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h2>正在发起 USDT 支付...</h2>
  <p id="status">请稍候...</p>

  <script>
    async function main() {
      if (!window.ethereum) {
        document.getElementById('status').innerText = '请在币安钱包中打开此页面'
        return
      }

      const params = new URLSearchParams(location.search)
      const to = params.get('to')
      const amount = params.get('amount')
      const contract = params.get('contract')

      const provider = new ethers.BrowserProvider(window.ethereum)
      const signer = await provider.getSigner()

      // USDT 合约 ABI
      const abi = [
        "function transfer(address to, uint256 amount) public returns (bool)"
      ]
      const usdt = new ethers.Contract(contract, abi, signer)

      try {
        const decimals = 18 // BSC USDT 是 18 位
        const amountWei = ethers.parseUnits(amount, decimals)

        const tx = await usdt.transfer(to, amountWei)
        document.getElementById('status').innerText = '交易已提交，等待确认中...'

        const receipt = await tx.wait()
        document.getElementById('status').innerText = `交易成功！哈希：${tx.hash}`

        // 向App回传交易hash
        if (window.uni) {
          uni.postMessage({ data: { hash: tx.hash } })
        } else if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(tx.hash)
        } else {
          console.log('交易哈希:', tx.hash)
        }

      } catch (err) {
        document.getElementById('status').innerText = '交易失败: ' + err.message
      }
    }

    main()
  </script>
</body>
</html>
