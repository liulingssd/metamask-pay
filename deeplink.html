<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Direct Crypto Payment</title>
  <!-- 外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#10b981',
            dark: '#1e293b',
            light: '#f8fafc'
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .glass-dark {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .animate-float {
        animation: float 6s ease-in-out infinite;
      }
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-15px); }
        100% { transform: translateY(0px); }
      }
    }
  </style>
</head>
<body class="font-inter bg-gradient-to-br from-dark to-slate-800 text-light min-h-screen">
  <!-- 背景装饰 -->
  <div class="fixed inset-0 overflow-hidden -z-10">
    <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-primary/20 rounded-full filter blur-3xl animate-float"></div>
    <div class="absolute bottom-1/3 right-1/3 w-80 h-80 bg-secondary/20 rounded-full filter blur-3xl animate-float" style="animation-delay: 2s;"></div>
  </div>

  <div class="container mx-auto px-4 py-12 max-w-4xl">
    <!-- 页面标题 -->
    <header class="text-center mb-12">
      <h1 class="text-[clamp(1.8rem,4vw,3rem)] font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary mb-4">
        快速加密支付
      </h1>
      <p class="text-slate-300 text-lg max-w-2xl mx-auto">
        输入金额，点击支付，系统将自动为您拉起钱包完成交易
      </p>
    </header>

    <main>
      <!-- 支付表单 -->
      <div class="glass-dark rounded-2xl p-6 shadow-xl border border-white/10">
        <form id="paymentForm" class="space-y-6">
          <div>
            <label for="recipientAddress" class="block text-sm font-medium text-slate-300 mb-1">收款地址</label>
            <input 
              type="text" 
              id="recipientAddress" 
              class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 text-light"
              placeholder="0x..."
              required
            >
          </div>
          
          <div>
            <label for="amount" class="block text-sm font-medium text-slate-300 mb-1">金额 (ETH)</label>
            <input 
              type="number" 
              id="amount" 
              class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 text-light"
              placeholder="0.0"
              min="0.0001"
              step="0.0001"
              required
            >
          </div>
          
          <div>
            <label for="walletType" class="block text-sm font-medium text-slate-300 mb-1">选择钱包</label>
            <select 
              id="walletType" 
              class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 text-light"
            >
              <option value="metamask">MetaMask</option>
              <option value="binance">币安钱包</option>
            </select>
          </div>
          
          <button 
            type="submit" 
            id="submitPayment" 
            class="w-full py-3 px-4 bg-gradient-to-r from-primary to-secondary text-white rounded-xl font-medium transition-all duration-300 hover:shadow-lg hover:shadow-primary/20 transform hover:-translate-y-1"
          >
            <i class="fa fa-paper-plane mr-2"></i> 立即支付
          </button>
        </form>
        
        <!-- 状态信息区 -->
        <div id="statusContainer" class="mt-6 hidden">
          <div class="p-4 rounded-xl border transition-all duration-300" id="statusContent">
            <!-- 状态将由JavaScript填充 -->
          </div>
        </div>
        
        <!-- 交易哈希 -->
        <div id="transactionHashContainer" class="mt-6 hidden">
          <div class="p-4 rounded-xl bg-slate-800/50 border border-slate-700">
            <h3 class="font-semibold mb-2 text-secondary">交易成功!</h3>
            <p class="text-sm text-slate-300 mb-2">您的交易哈希:</p>
            <div class="flex">
              <span id="transactionHash" class="text-sm bg-slate-900/80 p-2 rounded text-primary break-all flex-1"></span>
              <button id="copyHash" class="ml-2 px-2 py-2 bg-primary/20 hover:bg-primary/30 rounded transition-colors">
                <i class="fa fa-copy text-primary"></i>
              </button>
            </div>
            <p class="text-xs text-slate-400 mt-2">
              您可以在 
              <a href="" id="explorerLink" target="_blank" class="text-primary hover:underline">区块链浏览器</a>
              上查看您的交易
            </p>
          </div>
        </div>
      </div>
      
      <!-- 支付说明 -->
      <div class="mt-8 p-4 glass-dark rounded-xl border border-white/10">
        <h3 class="font-medium text-primary mb-2 flex items-center">
          <i class="fa fa-info-circle mr-2"></i> 支付说明
        </h3>
        <ul class="text-sm text-slate-300 space-y-1 list-disc list-inside">
          <li>点击"立即支付"后，系统将自动请求连接您选择的钱包</li>
          <li>请在钱包弹窗中确认交易详情并授权支付</li>
          <li>交易完成后，您将获得唯一的交易哈希用于查询</li>
        </ul>
      </div>
    </main>
    
    <!-- 页脚 -->
    <footer class="mt-12 text-center text-slate-400 text-sm">
      <p>安全加密支付处理 © 2023</p>
    </footer>
  </div>

  <script>
    // 全局变量
    let provider;
    let signer;
    let address;
    let currentNetwork;
    
    // DOM元素
    const paymentForm = document.getElementById('paymentForm');
    const submitPayment = document.getElementById('submitPayment');
    const statusContainer = document.getElementById('statusContainer');
    const statusContent = document.getElementById('statusContent');
    const transactionHashContainer = document.getElementById('transactionHashContainer');
    const transactionHash = document.getElementById('transactionHash');
    const copyHash = document.getElementById('copyHash');
    const explorerLink = document.getElementById('explorerLink');
    const walletTypeSelect = document.getElementById('walletType');
    
    // 显示状态信息
    function showStatus(message, type = 'info') {
      const typeClasses = {
        info: 'border-blue-500/30 bg-blue-900/20 text-blue-400',
        success: 'border-green-500/30 bg-green-900/20 text-green-400',
        error: 'border-red-500/30 bg-red-900/20 text-red-400',
        warning: 'border-yellow-500/30 bg-yellow-900/20 text-yellow-400'
      };
      
      const icons = {
        info: 'fa-info-circle',
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle'
      };
      
      statusContent.className = `p-4 rounded-xl border transition-all duration-300 ${typeClasses[type]}`;
      statusContent.innerHTML = `
        <div class="flex items-center">
          <i class="fa ${icons[type]} mr-2"></i>
          <p>${message}</p>
        </div>
      `;
      statusContainer.classList.remove('hidden');
      transactionHashContainer.classList.add('hidden');
    }
    
    // 检查钱包是否安装
    function isWalletInstalled(type) {
      if (type === 'metamask') {
        return typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask;
      } else if (type === 'binance') {
        return typeof window.BinanceChain !== 'undefined';
      }
      return false;
    }
    
    // 连接钱包（如果未连接）
    async function connectWalletIfNeeded(type) {
      // 检查是否已连接
      if (address && provider) {
        return true;
      }
      
      // 检查钱包是否安装
      if (!isWalletInstalled(type)) {
        const walletNames = {
          metamask: 'MetaMask',
          binance: '币安钱包'
        };
        showStatus(`未检测到${walletNames[type]}，请先安装钱包扩展程序`, 'error');
        return false;
      }
      
      try {
        // 显示连接中状态
        showStatus('正在连接钱包...请在钱包中授权访问');
        
        // 获取钱包提供者
        const providerObj = type === 'metamask' ? window.ethereum : window.BinanceChain;
        
        // 请求账户访问（这会自动拉起钱包）
        await providerObj.request({ method: 'eth_requestAccounts' });
        
        // 初始化ethers提供者
        provider = new ethers.providers.Web3Provider(providerObj);
        signer = provider.getSigner();
        
        // 获取账户信息
        const accounts = await provider.listAccounts();
        address = accounts[0];
        
        // 获取网络信息
        currentNetwork = await provider.getNetwork().then(network => network.chainId.toString(16));
        
        return true;
      } catch (error) {
        console.error('钱包连接错误:', error);
        showStatus(`连接失败: ${error.message || '用户拒绝授权'}`, 'error');
        return false;
      }
    }
    
    // 处理支付表单提交
    paymentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // 获取表单数据
      const recipient = document.getElementById('recipientAddress').value;
      const amount = document.getElementById('amount').value;
      const walletType = walletTypeSelect.value;
      
      // 验证输入
      if (!ethers.utils.isAddress(recipient)) {
        showStatus('请输入有效的收款地址', 'error');
        return;
      }
      
      if (isNaN(amount) || parseFloat(amount) <= 0) {
        showStatus('请输入有效的支付金额', 'error');
        return;
      }
      
      // 连接钱包（自动拉起）
      const isConnected = await connectWalletIfNeeded(walletType);
      if (!isConnected) {
        return;
      }
      
      try {
        // 显示交易处理中状态
        showStatus('正在处理交易...请在钱包中确认', 'info');
        
        // 转换金额为wei
        const amountWei = ethers.utils.parseEther(amount);
        
        // 获取gas价格
        const gasPrice = await provider.getGasPrice();
        
        // 估算gas
        const gasLimit = await provider.estimateGas({
          to: recipient,
          value: amountWei
        });
        
        // 发送交易（这会自动拉起钱包让用户确认）
        const tx = await signer.sendTransaction({
          to: recipient,
          value: amountWei,
          gasPrice: gasPrice,
          gasLimit: gasLimit
        });
        
        // 显示等待确认状态
        showStatus(`交易已提交，等待区块链确认...<br>哈希: ${tx.hash.substring(0, 10)}...`, 'warning');
        
        // 等待交易被打包
        const receipt = await tx.wait();
        
        if (receipt.status === 1) {
          // 交易成功
          showStatus('交易已确认成功', 'success');
          
          // 显示交易哈希
          transactionHash.textContent = tx.hash;
          transactionHashContainer.classList.remove('hidden');
          
          // 设置区块链浏览器链接
          let explorerUrl;
          switch(currentNetwork) {
            case '0x1': // 以太坊主网
              explorerUrl = `https://etherscan.io/tx/${tx.hash}`;
              break;
            case '0x38': // BSC
              explorerUrl = `https://bscscan.com/tx/${tx.hash}`;
              break;
            case '0x89': // Polygon
              explorerUrl = `https://polygonscan.com/tx/${tx.hash}`;
              break;
            default:
              explorerUrl = `https://etherscan.io/tx/${tx.hash}`;
          }
          
          explorerLink.href = explorerUrl;
        } else {
          // 交易失败
          showStatus('交易失败，可能是因为gas不足或被拒绝', 'error');
        }
        
      } catch (error) {
        console.error('交易错误:', error);
        showStatus(`交易被取消或失败: ${error.message}`, 'error');
      }
    });
    
    // 复制交易哈希
    copyHash.addEventListener('click', () => {
      const hash = transactionHash.textContent;
      navigator.clipboard.writeText(hash).then(() => {
        const originalIcon = copyHash.innerHTML;
        copyHash.innerHTML = '<i class="fa fa-check text-green-400"></i>';
        
        setTimeout(() => {
          copyHash.innerHTML = originalIcon;
        }, 2000);
      });
    });
  </script>
</body>
</html>
