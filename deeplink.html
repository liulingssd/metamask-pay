<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>加密支付 - 离线支持版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 主要CDN -->
  <script src="https://unpkg.com/ethers@5.6.0/dist/ethers.umd.min.js" onload="window.ethersLoaded = true"></script>
  
  <style>
    .glass {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
    }
    .status-success { background-color: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; color: #22c55e; }
    .status-error { background-color: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #ef4444; }
    .status-info { background-color: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; color: #3b82f6; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">
  <div class="container mx-auto max-w-2xl">
    <header class="text-center mb-6">
      <h1 class="text-2xl md:text-3xl font-bold mb-2 text-blue-400">加密货币支付</h1>
      <p class="text-gray-400">离线支持版本 - 解决ethers.js加载问题</p>
    </header>

    <div class="glass rounded-xl p-5 shadow-lg mb-6">
      <!-- 库加载状态 -->
      <div id="libStatus" class="p-3 rounded mb-4 hidden">
        <div class="flex items-center">
          <i id="libIcon" class="fa fa-circle-o-notch fa-spin mr-2"></i>
          <span id="libMessage">正在加载必要组件...</span>
        </div>
      </div>
      
      <form id="paymentForm" class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">收款地址</label>
          <input 
            type="text" 
            id="recipient" 
            class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 text-white"
            value="0x742d35Cc6634C0532925a3b844Bc454e4438f44e"
            required
          >
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">金额 (ETH)</label>
          <input 
            type="number" 
            id="amount" 
            class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 text-white"
            value="0.01" 
            min="0.001" 
            step="0.001"
            required
          >
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">选择钱包</label>
          <select id="wallet" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 text-white">
            <option value="metamask">MetaMask</option>
            <option value="binance">币安钱包</option>
          </select>
        </div>
        
        <button 
          type="button" 
          id="payButton" 
          class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors mt-4"
          disabled
        >
          <i class="fa fa-paper-plane mr-2"></i> 立即支付
        </button>
      </form>
      
      <!-- 状态区域 -->
      <div id="status" class="mt-4 p-3 rounded hidden"></div>
      
      <!-- 交易哈希区域 -->
      <div id="txHashArea" class="mt-4 p-3 rounded bg-gray-800 hidden">
        <h4 class="text-green-400 font-medium mb-2">交易哈希</h4>
        <div class="flex">
          <span id="txHash" class="text-sm text-blue-400 break-all flex-1"></span>
          <button id="copyBtn" class="ml-2 px-2 text-gray-400 hover:text-blue-400">
            <i class="fa fa-copy"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- 离线解决方案 -->
    <div class="glass rounded-xl p-5 mb-6">
      <h3 class="text-lg font-medium text-yellow-400 mb-3 flex items-center">
        <i class="fa fa-exclamation-triangle mr-2"></i> 解决ethers.js加载失败
      </h3>
      
      <div id="offlineGuide" class="text-sm text-gray-300 space-y-3">
        <p>如果您看到"加载失败"提示，请尝试以下解决方案：</p>
        
        <div class="p-3 bg-gray-800 rounded-lg">
          <h4 class="text-blue-400 font-medium mb-2">方案1：手动下载并使用本地文件</h4>
          <ol class="list-decimal list-inside space-y-2">
            <li>下载ethers.js文件: <a href="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js" class="text-blue-400 hover:underline" download>点击下载</a></li>
            <li>将下载的文件保存在与本HTML文件相同的文件夹中</li>
            <li>将本页面中加载ethers的代码改为:
              <div class="bg-gray-900 p-2 rounded mt-1 text-xs">
                &lt;script src="ethers-5.6.umd.min.js"&gt;&lt;/script&gt;
              </div>
            </li>
            <li>重新打开本页面</li>
          </ol>
        </div>
        
        <div class="p-3 bg-gray-800 rounded-lg">
          <h4 class="text-blue-400 font-medium mb-2">方案2：检查网络连接</h4>
          <ul class="list-disc list-inside space-y-1">
            <li>确保您的网络连接正常</li>
            <li>尝试关闭VPN或切换网络</li>
            <li>检查防火墙设置，确保允许访问CDN</li>
            <li>尝试使用不同的浏览器</li>
          </ul>
        </div>
      </div>
      
      <!-- 网络检测工具 -->
      <div class="mt-4 p-3 bg-gray-800 rounded-lg">
        <h4 class="text-blue-400 font-medium mb-2">CDN连接检测</h4>
        <button id="testCdnBtn" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">
          检测CDN连接
        </button>
        <div id="cdnTestResult" class="mt-2 text-sm hidden"></div>
      </div>
    </div>
  </div>

  <script>
    // 全局变量
    let retryCount = 0;
    const maxRetries = 3;
    
    // DOM元素
    const payButton = document.getElementById('payButton');
    const libStatus = document.getElementById('libStatus');
    const libIcon = document.getElementById('libIcon');
    const libMessage = document.getElementById('libMessage');
    const status = document.getElementById('status');
    const txHashArea = document.getElementById('txHashArea');
    const txHash = document.getElementById('txHash');
    const copyBtn = document.getElementById('copyBtn');
    const testCdnBtn = document.getElementById('testCdnBtn');
    const cdnTestResult = document.getElementById('cdnTestResult');
    
    // 显示库加载状态
    function showLibStatus(message, type = 'info') {
      libStatus.classList.remove('hidden', 'status-success', 'status-error', 'status-info');
      libStatus.classList.add(`status-${type}`);
      libMessage.textContent = message;
      
      // 更新图标
      libIcon.className = '';
      if (type === 'info') {
        libIcon.className = 'fa fa-circle-o-notch fa-spin mr-2';
      } else if (type === 'success') {
        libIcon.className = 'fa fa-check mr-2';
      } else if (type === 'error') {
        libIcon.className = 'fa fa-exclamation-circle mr-2';
      }
    }
    
    // 显示状态消息
    function showStatus(message, isError = false) {
      status.textContent = message;
      status.classList.remove('hidden', 'status-success', 'status-error', 'status-info');
      status.classList.add(isError ? 'status-error' : 'status-info');
      txHashArea.classList.add('hidden');
    }
    
    // 显示交易哈希
    function showTransactionHash(hash) {
      txHash.textContent = hash;
      txHashArea.classList.remove('hidden');
      status.classList.remove('hidden', 'status-success', 'status-error', 'status-info');
      status.classList.add('status-success');
      status.textContent = '交易已发送，等待确认';
    }
    
    // 检查ethers是否加载
    function checkEthers() {
      return typeof window.ethers !== 'undefined';
    }
    
    // 尝试加载备用CDN
    function loadBackupCDN() {
      if (retryCount >= maxRetries) return false;
      
      retryCount++;
      showLibStatus(`主CDN加载失败，尝试备用CDN (${retryCount}/${maxRetries})...`);
      
      return new Promise((resolve) => {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/ethers@5.6.umd.min.js';
        
        script.onload = () => {
          showLibStatus('ethers.js加载成功', 'success');
          payButton.disabled = false;
          resolve(true);
        };
        
        script.onerror = () => {
          if (retryCount < maxRetries) {
            setTimeout(() => resolve(loadBackupCDN()), 2000);
          } else {
            showLibStatus('所有CDN均加载失败，请尝试离线方案', 'error');
            resolve(false);
          }
        };
        
        document.head.appendChild(script);
      });
    }
    
    // 检测CDN连接
    async function testCDNConnections() {
      testCdnBtn.disabled = true;
      testCdnBtn.textContent = '检测中...';
      cdnTestResult.classList.remove('hidden', 'status-success', 'status-error', 'status-info');
      cdnTestResult.classList.add('status-info');
      cdnTestResult.innerHTML = '<i class="fa fa-circle-o-notch fa-spin mr-1"></i> 正在检测CDN连接...';
      
      const cdnList = [
        { name: '主CDN', url: 'https://cdn.ethers.io/lib/ethers-5.6.umd.min.js' },
        { name: '备用CDN', url: 'https://unpkg.com/ethers@5.6.umd.min.js' }
      ];
      
      let results = '';
      let allFailed = true;
      
      for (const cdn of cdnList) {
        try {
          const response = await fetch(cdn.url, { method: 'HEAD' });
          results += `<div><i class="fa fa-check text-green-400 mr-1"></i> ${cdn.name}: 连接成功</div>`;
          allFailed = false;
        } catch (error) {
          results += `<div><i class="fa fa-times text-red-400 mr-1"></i> ${cdn.name}: 连接失败</div>`;
        }
      }
      
      cdnTestResult.innerHTML = results;
      cdnTestResult.classList.remove('status-info', 'status-success', 'status-error');
      cdnTestResult.classList.add(allFailed ? 'status-error' : 'status-success');
      
      testCdnBtn.disabled = false;
      testCdnBtn.textContent = '重新检测';
    }
    
    // 支付处理
    async function processPayment() {
      if (!checkEthers()) {
        showStatus('ethers.js未加载，请解决加载问题后重试', true);
        return;
      }
      
      payButton.disabled = true;
      payButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 处理中...';
      
      try {
        const recipient = document.getElementById('recipient').value;
        const amount = document.getElementById('amount').value;
        const walletType = document.getElementById('wallet').value;
        
        // 验证输入
        if (!window.ethers.utils.isAddress(recipient)) {
          showStatus('无效的收款地址', true);
          throw new Error('无效地址');
        }
        
        if (isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus('请输入有效的金额', true);
          throw new Error('无效金额');
        }
        
        // 检查钱包
        const walletNames = { metamask: 'MetaMask', binance: '币安钱包' };
        const walletExists = walletType === 'metamask' 
          ? (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask)
          : (typeof window.BinanceChain !== 'undefined');
          
        if (!walletExists) {
          showStatus(`${walletNames[walletType]}未安装或未启用`, true);
          throw new Error('钱包不存在');
        }
        
        // 连接钱包
        showStatus(`正在连接${walletNames[walletType]}...`);
        const providerObj = walletType === 'metamask' ? window.ethereum : window.BinanceChain;
        await providerObj.request({ method: 'eth_requestAccounts' });
        
        const provider = new window.ethers.providers.Web3Provider(providerObj);
        const signer = provider.getSigner();
        
        // 发送交易
        showStatus('准备交易...请在钱包中确认');
        const tx = await signer.sendTransaction({
          to: recipient,
          value: window.ethers.utils.parseEther(amount)
        });
        
        showTransactionHash(tx.hash);
        
      } catch (error) {
        console.error('支付错误:', error);
        showStatus(`操作失败: ${error.message || '未知错误'}`, true);
      } finally {
        payButton.disabled = false;
        payButton.innerHTML = '<i class="fa fa-paper-plane mr-2"></i> 立即支付';
      }
    }
    
    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', () => {
      // 显示初始加载状态
      showLibStatus('正在加载ethers.js库...');
      
      // 检查ethers是否已加载
      setTimeout(() => {
        if (!checkEthers()) {
          // 尝试加载备用CDN
          loadBackupCDN();
        } else {
          showLibStatus('ethers.js加载成功', 'success');
          payButton.disabled = false;
        }
      }, 1000);
      
      // 事件监听
      payButton.addEventListener('click', processPayment);
      testCdnBtn.addEventListener('click', testCDNConnections);
      
      // 复制哈希
      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(tx.hash).then(() => {
          const original = copyBtn.innerHTML;
          copyBtn.innerHTML = '<i class="fa fa-check text-green-400"></i>';
          setTimeout(() => copyBtn.innerHTML = original, 2000);
        });
      });
    });
  </script>
</body>
</html>
